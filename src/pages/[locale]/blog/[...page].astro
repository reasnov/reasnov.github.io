---
import AppLayout from "@layouts/AppLayout.astro";
import { getCollection } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
	const locales = ["en", "id"];

	const allPosts = await Promise.all(
		locales.map(async (locale) => {
			const blogs = await getCollection("blog", (entry) => {
				const isNotDraft = import.meta.env.PROD ? !entry.data.draft : true;
				return isNotDraft && entry.id.startsWith(`${locale}/`);
			});

			blogs.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

			return paginate(blogs, {
				params: { locale },
				pageSize: 15,
			});
		})
	);

	return allPosts.flat();
};

const { page } = Astro.props as { page: Page<CollectionEntry<"blog">> };
const locale = Astro.params.locale as string;

const today = new Date();
const oneWeekAgo = new Date(today);
oneWeekAgo.setDate(today.getDate() - 7);
---

<AppLayout>
	<div class="my-10 flex flex-col gap-8" data-aos="fade-up">
		<h1 class="border-accent w-fit border-b-4 pb-2 font-black">{trans("nav.blog", {}, locale)}</h1>

		<div class="flex w-full flex-col">
			{
				page.data.map((blog) => {
					const postDate = blog.data.pubDate;
					const isNew = postDate >= oneWeekAgo;

					return (
						<div
							class="group border-border/10 hover:bg-primary/5 flex flex-col justify-between border-b px-4 py-6 transition-colors md:flex-row md:items-center"
							data-aos="fade-up"
						>
							<div class="flex flex-1 items-center gap-4">
								{isNew && (
									<span class="border-accent text-accent animate-pulse border px-2 py-0.5 text-[10px] font-bold">
										NEW
									</span>
								)}
								<a
									href={getRelativeLocaleUrl(locale, `blog/${blog.id.replace(`${locale}/`, "")}`)}
									class="group-hover:text-accent text-xl font-bold transition-colors"
								>
									{blog.data.title}
								</a>
							</div>
							<div class="text-content/40 mt-2 text-sm font-bold md:mt-0">
								{postDate.toLocaleDateString(locale, {
									year: "numeric",
									month: "long",
									day: "numeric",
								})}
							</div>
						</div>
					);
				})
			}
		</div>

		<div class="my-10 flex items-center justify-center gap-6">
			{
				page.url.prev && (
					<a href={page.url.prev} class="tui-btn-secondary">
						&laquo; {trans("blog.prev", {}, locale)}
					</a>
				)
			}
			{
				page.url.next && (
					<a href={page.url.next} class="tui-btn-secondary">
						{trans("blog.next", {}, locale)} &raquo;
					</a>
				)
			}
		</div>
	</div>
</AppLayout>
