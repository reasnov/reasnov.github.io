---
import BlogLayout from "@layouts/BlogLayout.astro";
import { getCollection, render } from "astro:content";
import { getReadingTime } from "@core/Content";
import { generateBlogPostingSchema } from "@core/SEO";
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";

export async function getStaticPaths() {
	const locales = ["en", "id"];

	const allPaths = await Promise.all(
		locales.map(async (locale) => {
			const posts = await getCollection("blog", (entry) => {
				const isNotDraft = import.meta.env.PROD ? !entry.data.draft : true;
				return isNotDraft && entry.id.startsWith(`${locale}/`);
			});

			posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

			return posts.map((post, index) => ({
				params: {
					locale,
					id: post.id.replace(`${locale}/`, ""),
				},
				props: {
					post,
					prev: index < posts.length - 1 ? posts[index + 1] : null,
					next: index > 0 ? posts[index - 1] : null,
				},
			}));
		})
	);

	return allPaths.flat();
}

const { post, prev, next } = Astro.props;
const { Content, headings } = await render(post);
const readingTime = getReadingTime(post.body ?? "");
const locale = Astro.params.locale as string;

const schema = generateBlogPostingSchema({
	title: post.data.title,
	description: post.data.description,
	pubDate: post.data.pubDate,
	updatedDate: post.data.updatedDate,
	url: new URL(Astro.url.pathname, Astro.site).toString(),
	heroImage: post.data.heroImage,
});
---

<BlogLayout
	title={post.data.title}
	date={post.data.pubDate}
	readingTime={readingTime}
	schema={schema}
	headings={headings}
>
	<Content />

	<div
		class="mt-16 flex flex-col justify-between gap-8 border-t border-border/10 pt-8 sm:flex-row"
	>
		{
			prev && (
				<a
					href={getRelativeLocaleUrl(locale, `blog/${prev.id.replace(`${locale}/`, "")}`)}
					class="group flex flex-1 flex-col gap-2 border border-border/10 p-4 transition-colors hover:border-accent"
				>
					<span class="flex items-center gap-2 text-xs font-bold tracking-widest text-content/40 uppercase">
						<span class="icon-[tabler--arrow-left] size-3" />
						{trans("blog.prev", {}, locale)}
					</span>
					<span class="group-hover:text-accent line-clamp-2 font-bold transition-colors">
						{prev.data.title}
					</span>
				</a>
			)
		}
		{
			next && (
				<a
					href={getRelativeLocaleUrl(locale, `blog/${next.id.replace(`${locale}/`, "")}`)}
					class="group flex flex-1 flex-col gap-2 border border-border/10 p-4 text-right transition-colors hover:border-accent"
				>
					<span class="flex items-center justify-end gap-2 text-xs font-bold tracking-widest text-content/40 uppercase">
						{trans("blog.next", {}, locale)}
						<span class="icon-[tabler--arrow-right] size-3" />
					</span>
					<span class="group-hover:text-accent line-clamp-2 font-bold transition-colors">
						{next.data.title}
					</span>
				</a>
			)
		}
	</div>
</BlogLayout>
