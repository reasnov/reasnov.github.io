---
import BlogLayout from "@layouts/BlogLayout.astro";
import { getCollection, render } from "astro:content";
import { getReadingTime } from "@core/Content";
import { generateBlogPostingSchema } from "@core/SEO";
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";

export async function getStaticPaths() {
	const posts = await getCollection("blog", (entry) => {
		const isNotDraft = import.meta.env.PROD ? !entry.data.draft : true;
		return isNotDraft && entry.id.startsWith("id/");
	});

	posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

	return posts.map((post, index) => ({
		params: { id: post.id.replace("id/", "") },
		props: {
			post,
			prev: index < posts.length - 1 ? posts[index + 1] : null,
			next: index > 0 ? posts[index - 1] : null,
		},
	}));
}

const { post, prev, next } = Astro.props;
const { Content, headings } = await render(post);
const readingTime = getReadingTime(post.body ?? "");
const locale = Astro.currentLocale || "en";

const schema = generateBlogPostingSchema({
	title: post.data.title,
	description: post.data.description,
	pubDate: post.data.pubDate,
	updatedDate: post.data.updatedDate,
	url: new URL(Astro.url.pathname, Astro.site).toString(),
	heroImage: post.data.heroImage,
});
---

<BlogLayout title={post.data.title} date={post.data.pubDate} readingTime={readingTime} schema={schema} headings={headings}>
	<Content />

	<div class="mt-16 pt-8 border-t border-neutral-100 dark:border-neutral-900 flex flex-col sm:flex-row justify-between gap-8">
		{
			prev && (
				<a
					href={getRelativeLocaleUrl(locale, `blog/${prev.id.replace(`${locale}/`, "")}`)}
					class="flex-1 group flex flex-col gap-2 p-4 border border-neutral-100 dark:border-neutral-800 hover:border-primary/50 transition-colors rounded-lg"
				>
					<span class="text-xs font-bold text-neutral-400 uppercase tracking-widest flex items-center gap-2">
						<span class="icon-[tabler--arrow-left] size-3" />
						{trans("blog.prev", {}, locale)}
					</span>
					<span class="font-bold group-hover:text-primary transition-colors line-clamp-2">{prev.data.title}</span>
				</a>
			)
		}
		{
			next && (
				<a
					href={getRelativeLocaleUrl(locale, `blog/${next.id.replace(`${locale}/`, "")}`)}
					class="flex-1 group flex flex-col gap-2 p-4 border border-neutral-100 dark:border-neutral-800 hover:border-primary/50 text-right transition-colors rounded-lg"
				>
					<span class="text-xs font-bold text-neutral-400 uppercase tracking-widest flex items-center justify-end gap-2">
						{trans("blog.next", {}, locale)}
						<span class="icon-[tabler--arrow-right] size-3" />
					</span>
					<span class="font-bold group-hover:text-primary transition-colors line-clamp-2">{next.data.title}</span>
				</a>
			)
		}
	</div>
</BlogLayout>
