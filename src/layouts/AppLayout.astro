---
// Styles
import "../styles/global.css";

// Components
import Head from "./partials/Head.astro";
import Header from "@components/partials/common/Header.astro";
import Footer from "@components/partials/common/Footer.astro";
import CommandPalette from "@components/ui/CommandPalette.astro";

import "aos/dist/aos.css";

const { ...props } = Astro.props;
const lang = Astro.currentLocale || "en";
---

<!doctype html>
<html lang={lang}>
	<head>
		<Head {...props} />

		<script is:inline>
			if (
				localStorage.getItem("color-theme") === "dark" ||
				(!("color-theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
			) {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
	</head>

	<body class="flex size-full min-h-screen max-w-screen flex-col overflow-x-hidden font-mono font-light">
		<Header />
		<CommandPalette />

		<main class="container mx-auto flex size-full flex-1 flex-col gap-8 p-4">
			<slot />
		</main>

		<Footer />

		<script>
			import AOS from "aos";
			AOS.init({
				duration: 800,
				once: true,
				offset: 100,
				easing: "ease-out-cubic",
			});

			/* --- Keyboard Navigation --- */
			let lastKey = "";
			const lang = document.documentElement.lang || "en";

			window.addEventListener("keydown", (e) => {
				// Ignore if user is typing in an input
				if (["INPUT", "TEXTAREA"].includes((e.target as HTMLElement).tagName)) return;

				const key = e.key.toLowerCase();

				// Function Keys (F1, F2)
				if (e.key === "F1") {
					e.preventDefault();
					document.getElementById("hero-f1")?.click();
				}
				if (e.key === "F2") {
					e.preventDefault();
					document.getElementById("hero-f2")?.click();
				}

				// Close Mobile Menu (ESC)
				if (e.key === "Escape") {
					const mobileMenu = document.getElementById("mobile-menu");
					if (mobileMenu && !mobileMenu.classList.contains("hidden")) {
						document.getElementById("mobile-menu-toggle")?.click();
					}
				}

				// Toggle Theme (T)
				if (key === "t") {
					document.getElementById("theme-toggle")?.click();
				}

				// Navigation (G then H/B/S/P)
				if (lastKey === "g") {
					if (key === "h") window.location.href = `/${lang}/`;
					if (key === "b") window.location.href = `/${lang}/blog/`;
					if (key === "s") window.location.href = `/${lang}/showcase/`;
					if (key === "p") window.location.href = `/${lang}/playgrounds/`;
				}

				// Help (?)
				if (key === "?") {
					window.dispatchEvent(new CustomEvent("open-palette", { detail: { query: "help" } }));
				}

				lastKey = key;
				// Reset lastKey after a short delay
				setTimeout(() => {
					if (lastKey === key) lastKey = "";
				}, 500);
			});

			// Listen for internal palette trigger
			window.addEventListener("open-palette", (e: any) => {
				const paletteEvent = new KeyboardEvent("keydown", {
					key: "k",
					ctrlKey: true,
					bubbles: true,
				});
				window.dispatchEvent(paletteEvent);
				
				if (e.detail?.query) {
					setTimeout(() => {
						const input = document.getElementById("palette-input") as HTMLInputElement;
						if (input) {
							input.value = e.detail.query;
							input.dispatchEvent(new Event("input"));
						}
					}, 50);
				}
			});
		</script>
	</body>
</html>
