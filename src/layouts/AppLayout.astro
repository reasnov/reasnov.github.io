---
// Styles
import "../styles/global.css";

// Components
import Head from "./partials/Head.astro";
import Header from "@components/partials/common/Header.astro";
import Footer from "@components/partials/common/Footer.astro";
import CommandPalette from "@components/ui/CommandPalette.astro";

import "aos/dist/aos.css";

const { ...props } = Astro.props;
const lang = Astro.currentLocale || "en";
---

<!doctype html>
<html lang={lang}>
	<head>
		<Head {...props} />

		<script is:inline>
			if (
				localStorage.getItem("color-theme") === "dark" ||
				(!("color-theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
			) {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
	</head>

	<body
		class="bg-base text-content selection:bg-primary selection:text-primary-content flex min-h-screen flex-col pt-16 font-mono"
	>
		<Header />
		<CommandPalette />

		<main
			class="container mx-auto flex w-full flex-1 flex-col gap-16 px-6 py-12 sm:px-8 md:gap-32 md:py-24 lg:px-12"
		>
			<slot />
		</main>

		<Footer />

		<script>
			import AOS from "aos";
			import { sound } from "@core/Sound";

			AOS.init({
				duration: 800,
				once: true,
				offset: 50,
				easing: "ease-out-cubic",
			});

			/* --- Global Sound Listeners --- */
			function attachSoundListeners() {
				// Click sounds for buttons and links
				const clickables = document.querySelectorAll('button, a, [role="button"], .tui-palette-item');
				clickables.forEach((el) => {
					el.addEventListener("click", () => sound.playClick());
					el.addEventListener("mouseenter", () => sound.playBlip());
				});
			}

			// Initial attach
			attachSoundListeners();
			// Re-attach on dynamic changes (like palette opening)
			window.addEventListener("open-palette", () => setTimeout(attachSoundListeners, 100));

			/* --- Global Keyboard Listeners --- */
			let lastKey = "";
			const lang = document.documentElement.lang || "en";

			window.addEventListener("keydown", (e) => {
				if (["INPUT", "TEXTAREA"].includes((e.target as HTMLElement).tagName)) return;

				const key = e.key.toLowerCase();

				// Function Keys
				if (e.key === "F1") {
					e.preventDefault();
					document.getElementById("hero-f1")?.click();
				}
				if (e.key === "F2") {
					e.preventDefault();
					document.getElementById("hero-f2")?.click();
				}

				// Escape Handler
				if (e.key === "Escape") {
					const mobileMenu = document.getElementById("mobile-menu");
					if (mobileMenu && !mobileMenu.classList.contains("hidden")) {
						document.getElementById("mobile-menu-toggle")?.click();
					}
				}

				if (key === "t") document.getElementById("theme-toggle")?.click();

				if (lastKey === "g") {
					if (key === "h") window.location.href = `/${lang}/`;
					if (key === "b") window.location.href = `/${lang}/blog/`;
					if (key === "s") window.location.href = `/${lang}/showcase/`;
					if (key === "p") window.location.href = `/${lang}/playgrounds/`;
				}

				if (key === "?") window.dispatchEvent(new CustomEvent("open-palette", { detail: { query: "help" } }));

				lastKey = key;
				setTimeout(() => {
					if (lastKey === key) lastKey = "";
				}, 500);
			});

			window.addEventListener("open-palette", (e: any) => {
				const paletteEvent = new KeyboardEvent("keydown", { key: "k", ctrlKey: true, bubbles: true });
				window.dispatchEvent(paletteEvent);
				if (e.detail?.query) {
					setTimeout(() => {
						const input = document.getElementById("palette-input") as HTMLInputElement;
						if (input) {
							input.value = e.detail.query;
							input.dispatchEvent(new Event("input"));
						}
					}, 50);
				}
			});
		</script>
	</body>
</html>
