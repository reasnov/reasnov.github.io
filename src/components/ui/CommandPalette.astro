---
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";
import { app_info } from "@core/AppInfo";

const lang = Astro.currentLocale || "en";
const version = app_info("app.version");

const commands = [
	{ id: "home", label: trans("nav.home", {}, lang), cmd: "goto home", url: getRelativeLocaleUrl(lang, "/") },
	{ id: "blog", label: trans("nav.blog", {}, lang), cmd: "goto blog", url: getRelativeLocaleUrl(lang, "blog") },
	{
		id: "showcase",
		label: trans("nav.showcase", {}, lang),
		cmd: "goto showcase",
		url: getRelativeLocaleUrl(lang, "showcase"),
	},
	{
		id: "playgrounds",
		label: trans("nav.playgrounds", {}, lang),
		cmd: "goto playgrounds",
		url: getRelativeLocaleUrl(lang, "playgrounds"),
	},
	{ id: "theme", label: "Toggle Theme", cmd: "theme toggle", action: "toggle-theme" },
	{ id: "help", label: "Show Help", cmd: "help", action: "show-help" },
];
---

<!-- COMMAND PALETTE (Z-100) -->
<div id="command-palette" class="tui-overlay !z-[100] hidden">
	<div class="tui-modal">
		<div class="tui-window-header border-border border-b-2">
			<div class="flex items-center gap-2">
				<span class="icon-[tabler--terminal] text-accent size-3"></span>
				<span>COMMAND_EXECUTOR.EXE</span>
			</div>
			<div class="flex items-center gap-4">
				<span class="hidden text-[9px] tracking-widest uppercase opacity-50 md:block">ESC to exit</span>
				<button id="palette-close-btn" class="text-accent font-black hover:underline">[X]</button>
			</div>
		</div>

		<div class="p-6 md:p-10">
			<div
				class="border-accent/30 focus-within:border-accent flex items-center gap-4 border-b-2 transition-colors"
			>
				<span class="animate-blink text-accent text-2xl font-black">!</span>
				<input
					type="text"
					id="palette-input"
					class="tui-palette-input"
					placeholder="Type a command (e.g. 'goto blog')..."
					autocomplete="off"
				/>
			</div>

			<div
				id="palette-results"
				class="no-scrollbar border-border/10 mt-6 max-h-[60vh] overflow-y-auto border-t pt-4"
			>
				{
					commands.map((cmd) => (
						<div
							class="group hover:bg-primary hover:text-primary-content focus:bg-primary focus:text-primary-content flex cursor-pointer items-center justify-between p-4 transition-all outline-none"
							data-url={cmd.url}
							data-action={cmd.action}
							data-cmd={cmd.cmd}
							tabindex="0"
						>
							<div class="flex flex-col">
								<span class="text-xs font-black tracking-widest uppercase">{cmd.label}</span>
								<span class="text-accent/60 group-hover:text-primary-content/60 group-focus:text-primary-content/60 text-[9px] italic">
									bash: {cmd.cmd}
								</span>
							</div>
							<div class="flex items-center gap-3">
								<span class="font-mono text-[10px] tracking-widest uppercase opacity-0 group-hover:opacity-100 group-focus:opacity-100">
									Execute
								</span>
								<kbd class="group-hover:border-primary-content group-hover:text-primary-content group-focus:border-primary-content group-focus:text-primary-content border-accent/20 text-accent">
									ENT
								</kbd>
							</div>
						</div>
					))
				}
				<div id="help-hint" class="border-accent/20 bg-accent/5 mt-4 hidden border border-dashed p-6">
					<p class="text-accent mb-4 text-[10px] font-black tracking-[0.2em] uppercase">
						Manual Page: HELP.MAN
					</p>
					<ul class="text-content/60 space-y-2 font-mono text-[10px] uppercase">
						<li>[T] - TOGGLE_THEME</li>
						<li>[G+H] - GOTO_HOME</li>
						<li>[G+B] - GOTO_BLOG</li>
						<li>[G+S] - GOTO_SHOWCASE</li>
						<li>[G+P] - GOTO_PLAYGROUNDS</li>
						<li>[/] - OPEN_PALETTE</li>
						<li>[?] - SHOW_THIS_HELP</li>
					</ul>
				</div>
			</div>

			<div
				class="border-border/5 text-content/30 mt-8 flex justify-between border-t pt-4 text-[9px] font-bold tracking-[0.2em] uppercase"
			>
				<span>Status: Awaiting Input</span>
				<span>{version}</span>
			</div>
		</div>
	</div>
</div>

<script>
	const palette = document.getElementById("command-palette");
	const input = document.getElementById("palette-input") as HTMLInputElement;
	const closeBtn = document.getElementById("palette-close-btn");

	function togglePalette() {
		if (!palette) return;
		palette.classList.toggle("hidden");
		if (!palette.classList.contains("hidden")) {
			input?.focus();
			input.value = "";
			filterCommands("");
		}
	}

	closeBtn?.addEventListener("click", togglePalette);

	function filterCommands(query: string) {
		const q = query.toLowerCase();
		const helpHint = document.getElementById("help-hint");
		if (q === "help") helpHint?.classList.remove("hidden");
		else helpHint?.classList.add("hidden");

		document.querySelectorAll("[data-cmd]").forEach((item) => {
			const cmd = item.getAttribute("data-cmd") || "";
			const label = item.querySelector("span")?.textContent?.toLowerCase() || "";
			if (cmd.includes(q) || label.includes(q)) {
				(item as HTMLElement).style.display = "flex";
			} else {
				(item as HTMLElement).style.display = "none";
			}
		});
	}

	window.addEventListener("keydown", (e) => {
		if ((e.ctrlKey || e.metaKey) && e.key === "k") {
			e.preventDefault();
			togglePalette();
		}
		if (e.key === "/" && !["INPUT", "TEXTAREA"].includes((e.target as HTMLElement).tagName)) {
			e.preventDefault();
			togglePalette();
		}
		if (e.key === "Escape" && palette && !palette.classList.contains("hidden")) togglePalette();
	});

	input?.addEventListener("input", (e) => filterCommands((e.target as HTMLInputElement).value));

	document.querySelectorAll("[data-url], [data-action]").forEach((item) => {
		item.addEventListener("click", () => {
			const url = item.getAttribute("data-url");
			const action = item.getAttribute("data-action");
			if (url) window.location.href = url;
			else if (action === "toggle-theme") {
				document.getElementById("theme-toggle")?.click();
				togglePalette();
			} else if (action === "show-help") {
				input.value = "help";
				filterCommands("help");
			}
		});
	});

	input?.addEventListener("keydown", (e) => {
		if (e.key === "Enter") {
			const visibleItems = Array.from(document.querySelectorAll("[data-url], [data-action]")).filter(
				(i) => (i as HTMLElement).style.display !== "none"
			);
			if (visibleItems.length > 0) (visibleItems[0] as HTMLElement).click();
		}
	});
</script>
