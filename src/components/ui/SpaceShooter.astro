---
/**
 * SpaceShooter Component
 * A terminal-themed mini-game for system integrity validation.
 */
interface Props {
	manual?: boolean;
}

const { manual = false } = Astro.props;
---

<div
	id="game-splash"
	class={`bg-bg fixed inset-0 z-[500] flex flex-col items-center justify-center font-mono ${manual ? "hidden" : ""}`}
>
	<!-- Game UI Overlay -->
	<div class="tui-window relative h-[600px] w-full max-w-4xl overflow-hidden shadow-2xl">
		<div class="tui-window-header">
			<div class="flex items-center gap-2">
				<span class="icon-[tabler--shield-check] text-accent size-3"></span>
				<span>SYSTEM_INTEGRITY_CHECK.EXE</span>
			</div>
			<div class="flex items-center gap-4">
				<span id="game-score" class="text-[10px] font-bold">BUGS_CLEARED: 0/10</span>
				<button id="skip-game" class="hover:text-accent text-[9px] opacity-50 hover:opacity-100"
					>[SKIP_PROTOCOL]</button
				>
			</div>
		</div>

		<div id="game-container" class="relative h-[calc(100%-28px)] w-full cursor-none bg-neutral-950">
			<!-- Background Stars -->
			<svg id="game-canvas" class="absolute inset-0 h-full w-full">
				<defs>
					<!-- Player Ship -->
					<g id="svg-player">
						<path d="M0 -15 L10 10 L0 5 L-10 10 Z" fill="none" stroke="currentColor" stroke-width="2"
						></path>
						<path d="M0 -5 L3 2 L0 0 L-3 2 Z" fill="var(--accent)"></path>
					</g>
					<!-- Enemy Bug -->
					<g id="svg-enemy">
						<rect x="-8" y="-8" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5"
						></rect>
						<path d="M-4 -4 L4 4 M-4 4 L4 -4" stroke="var(--accent)" stroke-width="1"></path>
						<circle cx="0" cy="0" r="2" fill="currentColor"></circle>
					</g>
					<!-- Bullet -->
					<circle id="svg-bullet" r="2" fill="var(--accent)"></circle>
				</defs>
				<g id="stars-group"></g>
				<g id="entities-group"></g>
			</svg>

			<!-- Mobile Controls (Visible only on touch devices) -->
			<div id="mobile-controls" class="pointer-events-none absolute inset-0 hidden select-none md:hidden">
				<div class="absolute bottom-8 left-8 flex gap-4">
					<div
						id="m-left"
						class="pointer-events-auto flex size-12 items-center justify-center border-2 border-white/20 bg-white/5 font-bold text-white active:bg-white/20"
					>
						&lt;
					</div>
					<div
						id="m-right"
						class="pointer-events-auto flex size-12 items-center justify-center border-2 border-white/20 bg-white/5 font-bold text-white active:bg-white/20"
					>
						&gt;
					</div>
				</div>
				<div
					id="m-shoot"
					class="border-accent/40 bg-accent/10 active:bg-accent/30 text-accent pointer-events-auto absolute right-8 bottom-8 flex size-16 items-center justify-center border-2 font-bold"
				>
					FIRE
				</div>
			</div>

			<!-- Start Screen -->
			<div
				id="start-screen"
				class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 p-8 text-center"
			>
				<h2 class="font-display text-accent mb-4 text-3xl">SECURITY THREAT DETECTED</h2>
				<p class="mb-8 max-w-md text-xs tracking-widest text-neutral-400 uppercase">
					Multiple 'Unclean_Code' bugs detected in home directory. Please execute cleanup protocol to proceed.
				</p>
				<button id="start-btn" class="tui-btn-primary tui-btn-lg">INITIALIZE_CLEANUP</button>
				<div class="mt-6 flex flex-col gap-2">
					<p class="text-[9px] text-neutral-500 uppercase">Desktop: [ARROWS] to Move, [SPACE] to Shoot</p>
					<p class="text-[9px] text-neutral-500 uppercase">Mobile: Use On-Screen Controls</p>
				</div>
			</div>

			<!-- Victory Screen -->
			<div
				id="victory-screen"
				class="absolute inset-0 flex hidden flex-col items-center justify-center bg-black/90 p-8 text-center"
			>
				<h2 class="font-display text-accent mb-4 text-3xl">SYSTEM_SECURED</h2>
				<p class="mb-8 text-xs tracking-widest text-neutral-400 uppercase">
					Integrity check passed. Redirecting to core...
				</p>
				<div class="h-1 w-48 overflow-hidden bg-neutral-800">
					<div class="bg-accent h-full animate-[loading_2s_ease-in-out]"></div>
				</div>
			</div>
		</div>
	</div>
	<p class="mt-4 text-[10px] font-bold tracking-[0.3em] text-neutral-500 uppercase">
		Authorized Access Only // @reasnov
	</p>
</div>

<style>
	@keyframes loading {
		from {
			width: 0%;
		}
		to {
			width: 100%;
		}
	}
</style>

<script>
	const splash = document.getElementById("game-splash");
	const container = document.getElementById("game-container");
	const entitiesGroup = document.getElementById("entities-group");
	const starsGroup = document.getElementById("stars-group");
	const startBtn = document.getElementById("start-btn");
	const skipBtn = document.getElementById("skip-game");
	const scoreEl = document.getElementById("game-score");
	const mobileControls = document.getElementById("mobile-controls");

	let isPlaying = false;
	let score = 0;
	const targetScore = 10;

	// Game State
	let player = { x: 400, y: 500, el: null as any, vx: 0, vy: 0 };
	let enemies = [] as any[];
	let bullets = [] as any[];
	let lastShootTime = 0;
	let keys = {} as Record<string, boolean>;

	// Touch State
	let touchState = { left: false, right: false, shoot: false };

	// Always show splash on refresh
	document.body.style.overflow = "hidden";

	function exitGame() {
		splash?.classList.add("opacity-0", "transition-opacity", "duration-1000");
		document.body.style.overflow = "";
		setTimeout(() => {
			splash?.classList.add("hidden");
			splash?.classList.remove("opacity-0");
		}, 1000);
	}

	window.addEventListener("trigger-game-reset", () => {
		score = 0;
		if (scoreEl) scoreEl.textContent = `BUGS_CLEARED: 0/${targetScore}`;
		document.getElementById("start-screen")?.classList.remove("hidden");
		document.getElementById("victory-screen")?.classList.add("hidden");
		isPlaying = false;
		// Clear entities
		if (entitiesGroup) entitiesGroup.innerHTML = "";
		bullets = [];
		enemies = [];
	});

	skipBtn?.addEventListener("click", exitGame);

	function initStars() {
		if (!starsGroup) return;
		for (let i = 0; i < 50; i++) {
			const star = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			star.setAttribute("r", (Math.random() * 1.5).toString());
			star.setAttribute("cx", Math.random() * 100 + "%");
			star.setAttribute("cy", Math.random() * 100 + "%");
			star.setAttribute("fill", "white");
			star.setAttribute("opacity", (Math.random() * 0.5).toString());
			starsGroup.appendChild(star);
		}
	}

	function spawnEnemy() {
		if (!isPlaying || enemies.length > 5 || !container) return;
		const x = Math.random() * container.clientWidth;
		const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
		el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-enemy");
		el.setAttribute("class", "text-neutral-400");
		entitiesGroup?.appendChild(el);
		enemies.push({ x, y: -20, el, speed: 1.5 + Math.random() * 2.5 });
	}

	function shoot() {
		const now = Date.now();
		if (now - lastShootTime < 200) return;
		lastShootTime = now;

		const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
		el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-bullet");
		entitiesGroup?.appendChild(el);
		bullets.push({ x: player.x, y: player.y - 20, el });
	}

	function gameLoop() {
		if (!isPlaying || !container) return;

		// Player Movement Logic
		const speed = 6;
		if (keys["ArrowLeft"] || touchState.left) player.vx = -speed;
		else if (keys["ArrowRight"] || touchState.right) player.vx = speed;
		else player.vx = 0;

		if (keys["ArrowUp"]) player.vy = -speed;
		else if (keys["ArrowDown"]) player.vy = speed;
		else player.vy = 0;

		if (keys[" "] || touchState.shoot) shoot();

		player.x += player.vx;
		player.y += player.vy;

		// Bounds
		player.x = Math.max(20, Math.min(container.clientWidth - 20, player.x));
		player.y = Math.max(20, Math.min(container.clientHeight - 20, player.y));

		player.el.setAttribute("transform", `translate(${player.x}, ${player.y})`);

		// Move Bullets
		bullets.forEach((b, i) => {
			b.y -= 12;
			b.el.setAttribute("transform", `translate(${b.x}, ${b.y})`);
			if (b.y < -10) {
				b.el.remove();
				bullets.splice(i, 1);
			}
		});

		// Move Enemies
		enemies.forEach((en, i) => {
			en.y += en.speed;
			en.el.setAttribute("transform", `translate(${en.x}, ${en.y})`);

			// Collision with bullets
			bullets.forEach((b, bi) => {
				const dist = Math.hypot(en.x - b.x, en.y - b.y);
				if (dist < 20) {
					score++;
					if (scoreEl) scoreEl.textContent = `BUGS_CLEARED: ${score}/${targetScore}`;
					en.el.remove();
					enemies.splice(i, 1);
					b.el.remove();
					bullets.splice(bi, 1);

					if (score >= targetScore) {
						isPlaying = false;
						document.getElementById("victory-screen")?.classList.remove("hidden");
						setTimeout(exitGame, 2000);
					}
				}
			});

			if (en.y > container.clientHeight + 20) {
				en.el.remove();
				enemies.splice(i, 1);
			}
		});

		if (Math.random() < 0.03) spawnEnemy();
		requestAnimationFrame(gameLoop);
	}

	startBtn?.addEventListener("click", () => {
		document.getElementById("start-screen")?.classList.add("hidden");
		isPlaying = true;

		// Init player
		const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
		el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-player");
		el.setAttribute("class", "text-neutral-100");
		entitiesGroup?.appendChild(el);
		player.el = el;

		// Center player
		if (container) {
			player.x = container.clientWidth / 2;
			player.y = container.clientHeight - 80;
		}

		initStars();
		gameLoop();

		// Check if touch device
		if ("ontouchstart" in window) {
			mobileControls?.classList.remove("hidden");
		}
	});

	// Keyboard Handlers
	window.addEventListener("keydown", (e) => {
		keys[e.key] = true;
	});
	window.addEventListener("keyup", (e) => {
		keys[e.key] = false;
	});

	// Mouse fallback for movement
	container?.addEventListener("mousemove", (e) => {
		if (keys["ArrowLeft"] || keys["ArrowRight"] || keys["ArrowUp"] || keys["ArrowDown"]) return;
		const rect = container.getBoundingClientRect();
		player.x = e.clientX - rect.left;
		player.y = e.clientY - rect.top;
	});
	container?.addEventListener("mousedown", shoot);

	// Mobile Control Handlers
	const mLeft = document.getElementById("m-left");
	const mRight = document.getElementById("m-right");
	const mShoot = document.getElementById("m-shoot");

	mLeft?.addEventListener("touchstart", (e) => {
		e.preventDefault();
		touchState.left = true;
	});
	mLeft?.addEventListener("touchend", () => (touchState.left = false));
	mRight?.addEventListener("touchstart", (e) => {
		e.preventDefault();
		touchState.right = true;
	});
	mRight?.addEventListener("touchend", () => (touchState.right = false));
	mShoot?.addEventListener("touchstart", (e) => {
		e.preventDefault();
		touchState.shoot = true;
	});
	mShoot?.addEventListener("touchend", () => (touchState.shoot = false));
</script>
