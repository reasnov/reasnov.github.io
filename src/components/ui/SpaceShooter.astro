---
/**
 * SpaceShooter Component
 * Fixed for responsive SVG scaling and Escape key support.
 */
interface Props {
	manual?: boolean;
}
const { manual = false } = Astro.props;
---

<div
	id="game-splash"
	class={`bg-base fixed inset-0 z-[500] flex flex-col items-center justify-center font-mono ${manual ? "hidden" : ""}`}
>
	<div class="tui-window relative h-[80dvh] w-[95vw] max-w-4xl overflow-hidden shadow-2xl">
		<div class="tui-window-header">
			<div class="flex items-center gap-2">
				<span class="icon-[tabler--shield-check] text-accent size-3"></span>
				<span>SYSTEM_INTEGRITY_CHECK.EXE</span>
			</div>
			<div class="flex items-center gap-4">
				<span id="game-score" class="text-[9px] font-bold">BUGS: 0/10</span>
				<button id="skip-game" class="hover:text-accent text-[9px] opacity-50 hover:opacity-100"
					>[ESC_TO_SKIP]</button
				>
			</div>
		</div>

		<div id="game-container" class="relative h-[calc(100%-28px)] w-full cursor-none bg-neutral-950">
			<svg id="game-canvas" class="absolute inset-0 h-full w-full" preserveAspectRatio="xMidYMid slice">
				<defs>
					<g id="svg-player">
						<path d="M0 -12 L8 8 L0 4 L-8 8 Z" fill="none" stroke="currentColor" stroke-width="2"></path>
						<path d="M0 -4 L2 2 L0 0 L-2 2 Z" fill="var(--accent)"></path>
					</g>
					<g id="svg-enemy">
						<rect x="-6" y="-6" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"
						></rect>
						<path d="M-3 -3 L3 3 M-3 3 L3 -3" stroke="var(--accent)" stroke-width="1"></path>
					</g>
					<circle id="svg-bullet" r="1.5" fill="var(--accent)"></circle>
				</defs>
				<g id="stars-group"></g>
				<g id="entities-group"></g>
			</svg>

			<div id="mobile-controls" class="pointer-events-none absolute inset-0 hidden touch-none select-none">
				<div class="absolute bottom-4 left-4 flex gap-2">
					<button
						id="m-left"
						class="pointer-events-auto flex size-12 items-center justify-center border border-white/20 bg-white/5 font-bold text-white"
						>&lt;</button
					>
					<button
						id="m-right"
						class="pointer-events-auto flex size-12 items-center justify-center border border-white/20 bg-white/5 font-bold text-white"
						>&gt;</button
					>
				</div>
				<button
					id="m-shoot"
					class="border-accent/40 bg-accent/10 text-accent pointer-events-auto absolute right-4 bottom-4 flex size-16 items-center justify-center border-2 font-bold"
					>FIRE</button
				>
			</div>

			<div
				id="start-screen"
				class="absolute inset-0 flex flex-col items-center justify-center bg-neutral-950/90 p-6 text-center"
			>
				<h2 class="font-display text-accent mb-4 text-xl sm:text-2xl">THREAT DETECTED</h2>
				<button id="start-btn" class="tui-btn-primary mb-4">INITIALIZE_CLEANUP</button>
				<p class="text-[8px] text-white/30 uppercase">[ESC] OR BUTTON TO SKIP</p>
			</div>

			<div
				id="victory-screen"
				class="absolute inset-0 flex hidden flex-col items-center justify-center bg-neutral-950/95 p-6 text-center"
			>
				<h2 class="font-display text-accent mb-4 text-2xl uppercase">Secured</h2>
				<div class="h-1 w-32 overflow-hidden bg-white/10">
					<div class="bg-accent h-full animate-[loading_2s_linear]"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	const splash = document.getElementById("game-splash");
	const container = document.getElementById("game-container");
	const entitiesGroup = document.getElementById("entities-group");
	const startBtn = document.getElementById("start-btn");
	const skipBtn = document.getElementById("skip-game");
	const scoreEl = document.getElementById("game-score");

	let isPlaying = false;
	let score = 0;
	const targetScore = 10;
	let player = { x: 0, y: 0, el: null as any, vx: 0, vy: 0 };
	let enemies = [] as any[];
	let bullets = [] as any[];
	let keys = {} as Record<string, boolean>;
	let lastShoot = 0;

	function exitGame() {
		if (!splash) return;
		splash.classList.add("opacity-0");
		isPlaying = false;
		document.body.style.overflow = "";
		setTimeout(() => splash.classList.add("hidden"), 500);
	}

	skipBtn?.addEventListener("click", exitGame);
	window.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && splash && !splash.classList.contains("hidden")) exitGame();
	});

	function gameLoop() {
		if (!isPlaying || !container) return;
		const w = container.clientWidth;
		const h = container.clientHeight;

		if (keys["ArrowLeft"]) player.vx = -5;
		else if (keys["ArrowRight"]) player.vx = 5;
		else player.vx *= 0.8;

		if (keys[" "]) {
			const now = Date.now();
			if (now - lastShoot > 200) {
				const b = document.createElementNS("http://www.w3.org/2000/svg", "use");
				b.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-bullet");
				entitiesGroup?.appendChild(b);
				bullets.push({ x: player.x, y: player.y - 15, el: b });
				lastShoot = now;
			}
		}

		player.x = Math.max(15, Math.min(w - 15, player.x + player.vx));
		player.el?.setAttribute("transform", `translate(${player.x}, ${player.y})`);

		bullets.forEach((b, i) => {
			b.y -= 8;
			b.el.setAttribute("transform", `translate(${b.x}, ${b.y})`);
			if (b.y < -10) {
				b.el.remove();
				bullets.splice(i, 1);
			}
		});

		enemies.forEach((en, i) => {
			en.y += en.s;
			en.el.setAttribute("transform", `translate(${en.x}, ${en.y})`);

			bullets.forEach((b, bi) => {
				if (Math.hypot(en.x - b.x, en.y - b.y) < 15) {
					score++;
					if (scoreEl) scoreEl.textContent = `BUGS: ${score}/${targetScore}`;
					en.el.remove();
					enemies.splice(i, 1);
					b.el.remove();
					bullets.splice(bi, 1);
					if (score >= targetScore) {
						isPlaying = false;
						document.getElementById("victory-screen")?.classList.remove("hidden");
						setTimeout(exitGame, 2000);
					}
				}
			});

			if (en.y > h + 20) {
				en.el.remove();
				enemies.splice(i, 1);
			}
		});

		if (Math.random() < 0.03 && enemies.length < 5) {
			const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
			el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-enemy");
			entitiesGroup?.appendChild(el);
			enemies.push({ x: Math.random() * w, y: -20, el, s: 1.5 + Math.random() * 2 });
		}

		requestAnimationFrame(gameLoop);
	}

	startBtn?.addEventListener("click", () => {
		document.getElementById("start-screen")?.classList.add("hidden");
		isPlaying = true;
		const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
		el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-player");
		entitiesGroup?.appendChild(el);
		player.el = el;
		player.x = (container?.clientWidth || 400) / 2;
		player.y = (container?.clientHeight || 500) - 40;
		gameLoop();
	});

	window.addEventListener("keydown", (e) => (keys[e.key] = true));
	window.addEventListener("keyup", (e) => (keys[e.key] = false));
</script>
