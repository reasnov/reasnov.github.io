---
import { trans } from "@core/Translator";
const locale = Astro.currentLocale || "en";
---

<div id="game-splash" class="fixed inset-0 z-[500] flex flex-col items-center justify-center bg-bg font-mono">
	<!-- Game UI Overlay -->
	<div class="tui-window relative h-[600px] w-full max-w-4xl overflow-hidden shadow-2xl">
		<div class="tui-window-header">
			<div class="flex items-center gap-2">
				<span class="icon-[tabler--shield-check] size-3 text-accent"></span>
				<span>SYSTEM_INTEGRITY_CHECK.EXE</span>
			</div>
			<div class="flex items-center gap-4">
				<span id="game-score" class="text-[10px] font-bold">BUGS_CLEARED: 0/10</span>
				<button id="skip-game" class="text-[9px] opacity-50 hover:opacity-100 hover:text-accent">[SKIP_PROTOCOL]</button>
			</div>
		</div>

		<div id="game-container" class="relative h-[calc(100%-28px)] w-full cursor-none bg-neutral-950">
			<!-- Background Stars -->
			<svg id="game-canvas" class="absolute inset-0 h-full w-full">
				<defs>
					<!-- Player Ship -->
					<g id="svg-player">
						<path d="M0 -15 L10 10 L0 5 L-10 10 Z" fill="none" stroke="currentColor" stroke-width="2"></path>
						<path d="M0 -5 L3 2 L0 0 L-3 2 Z" fill="var(--accent)"></path>
					</g>
					<!-- Enemy Bug -->
					<g id="svg-enemy">
						<rect x="-8" y="-8" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
						<path d="M-4 -4 L4 4 M-4 4 L4 -4" stroke="var(--accent)" stroke-width="1"></path>
						<circle cx="0" cy="0" r="2" fill="currentColor"></circle>
					</g>
                    <!-- Bullet -->
                    <circle id="svg-bullet" r="2" fill="var(--accent)"></circle>
				</defs>
                <g id="stars-group"></g>
                <g id="entities-group"></g>
			</svg>

			<!-- Start Screen -->
			<div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 text-center p-8">
				<h2 class="font-display text-3xl text-accent mb-4">SECURITY THREAT DETECTED</h2>
				<p class="text-xs text-neutral-400 max-w-md mb-8 uppercase tracking-widest">
					Multiple 'Unclean_Code' bugs detected in home directory. Please execute cleanup protocol to proceed.
				</p>
				<button id="start-btn" class="tui-btn-primary tui-btn-lg">INITIALIZE_CLEANUP</button>
                <p class="mt-4 text-[9px] text-neutral-600 uppercase">Controls: [MOUSE/TOUCH] to move & Shoot</p>
			</div>

            <!-- Victory Screen -->
            <div id="victory-screen" class="absolute inset-0 hidden flex flex-col items-center justify-center bg-black/90 text-center p-8">
				<h2 class="font-display text-3xl text-accent mb-4">SYSTEM_SECURED</h2>
				<p class="text-xs text-neutral-400 mb-8 uppercase tracking-widest">Integrity check passed. Redirecting to core...</p>
				<div class="h-1 w-48 bg-neutral-800 overflow-hidden">
                    <div class="h-full bg-accent animate-[loading_2s_ease-in-out]"></div>
                </div>
			</div>
		</div>
	</div>
    <p class="mt-4 text-[10px] text-neutral-500 font-bold uppercase tracking-[0.3em]">Authorized Access Only // @reasnov</p>
</div>

<style>
    @keyframes loading {
        from { width: 0% }
        to { width: 100% }
    }
</style>

<script>
    const splash = document.getElementById('game-splash');
    const container = document.getElementById('game-container');
    const entitiesGroup = document.getElementById('entities-group');
    const starsGroup = document.getElementById('stars-group');
    const startBtn = document.getElementById('start-btn');
    const skipBtn = document.getElementById('skip-game');
    const scoreEl = document.getElementById('game-score');
    
    let isPlaying = false;
    let score = 0;
    const targetScore = 10;
    
    // Check session
    if (sessionStorage.getItem('splash-completed')) {
        splash?.remove();
    } else {
        document.body.style.overflow = 'hidden';
    }

    function exitGame() {
        sessionStorage.setItem('splash-completed', 'true');
        splash?.classList.add('opacity-0', 'transition-opacity', 'duration-1000');
        document.body.style.overflow = '';
        setTimeout(() => splash?.remove(), 1000);
    }

    skipBtn?.addEventListener('click', exitGame);

    // Game Logic
    let player = { x: 0, y: 0, el: null as any };
    let enemies = [] as any[];
    let bullets = [] as any[];
    let lastShootTime = 0;

    function initStars() {
        for(let i=0; i<50; i++) {
            const star = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            star.setAttribute("r", (Math.random() * 1.5).toString());
            star.setAttribute("cx", (Math.random() * 100).toString() + "%");
            star.setAttribute("cy", (Math.random() * 100).toString() + "%");
            star.setAttribute("fill", "white");
            star.setAttribute("opacity", (Math.random() * 0.5).toString());
            starsGroup?.appendChild(star);
        }
    }

    function spawnEnemy() {
        if (!isPlaying || enemies.length > 5) return;
        const x = Math.random() * (container?.clientWidth || 800);
        const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
        el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-enemy");
        el.setAttribute("class", "text-neutral-400");
        entitiesGroup?.appendChild(el);
        enemies.push({ x, y: -20, el, speed: 1 + Math.random() * 2 });
    }

    function shoot() {
        const now = Date.now();
        if (now - lastShootTime < 250) return;
        lastShootTime = now;
        
        const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
        el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-bullet");
        entitiesGroup?.appendChild(el);
        bullets.push({ x: player.x, y: player.y - 20, el });
    }

    function gameLoop() {
        if (!isPlaying) return;

        // Move Bullets
        bullets.forEach((b, i) => {
            b.y -= 10;
            b.el.setAttribute("transform", `translate(${b.x}, ${b.y})`);
            if (b.y < -10) {
                b.el.remove();
                bullets.splice(i, 1);
            }
        });

        // Move Enemies
        enemies.forEach((en, i) => {
            en.y += en.speed;
            en.el.setAttribute("transform", `translate(${en.x}, ${en.y})`);
            
            // Collision with bullets
            bullets.forEach((b, bi) => {
                const dist = Math.hypot(en.x - b.x, en.y - b.y);
                if (dist < 20) {
                    score++;
                    if(scoreEl) scoreEl.textContent = `BUGS_CLEARED: ${score}/${targetScore}`;
                    en.el.remove();
                    enemies.splice(i, 1);
                    b.el.remove();
                    bullets.splice(bi, 1);
                    
                    if (score >= targetScore) {
                        isPlaying = false;
                        document.getElementById('victory-screen')?.classList.remove('hidden');
                        setTimeout(exitGame, 2000);
                    }
                }
            });

            if (en.y > (container?.clientHeight || 600)) {
                en.el.remove();
                enemies.splice(i, 1);
            }
        });

        if (Math.random() < 0.02) spawnEnemy();
        requestAnimationFrame(gameLoop);
    }

    startBtn?.addEventListener('click', () => {
        document.getElementById('start-screen')?.classList.add('hidden');
        isPlaying = true;
        
        // Init player
        const el = document.createElementNS("http://www.w3.org/2000/svg", "use");
        el.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#svg-player");
        el.setAttribute("class", "text-neutral-100");
        entitiesGroup?.appendChild(el);
        player.el = el;
        
        initStars();
        gameLoop();
    });

    container?.addEventListener('mousemove', (e) => {
        const rect = container.getBoundingClientRect();
        player.x = e.clientX - rect.left;
        player.y = e.clientY - rect.top;
        if (player.el) {
            player.el.setAttribute("transform", `translate(${player.x}, ${player.y})`);
        }
    });

    container?.addEventListener('mousedown', shoot);
    container?.addEventListener('touchstart', (e) => {
        e.preventDefault();
        shoot();
    });
</script>
