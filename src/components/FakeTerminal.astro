---
import fakeBootLog from "@data/fake-boot-log.json";

const terminalLines = fakeBootLog;
const speed = 20;
const delay = 800;
---

<div
	class="w-[90%] border border-neutral-700 p-3 flex flex-col justify-between h-80 bg-neutral-950 font-mono gap-3 font-medium relative text-sm"
>
	<div class="absolute top-0 flex items-center gap-2 px-3 py-2 -translate-y-1/2 bg-black z-5 right-6">
		<span class="block rounded-full size-3 bg-success"></span>
		<span class="block rounded-full size-3 bg-warning"></span>
		<span class="block rounded-full size-3 bg-error"></span>
	</div>

	<div class="flex items-center w-full gap-6">
		<p class="flex items-center justify-between gap-2 px-3 py-1 text-xs bg-neutral-900 min-w-24">
			<span>What's up!</span>
			<span class="text-[6pt] icon-[tabler--x] text-neutral-600"></span>
		</p>
	</div>

	<div class="flex flex-col justify-end flex-1 w-full overflow-auto">
		<div id="typewriter-output" class="flex flex-col w-full gap-1 text-sm"></div>

		<p class="flex items-center w-full gap-4 mt-3 text-nowrap">
			<span class="px-2 font-bold text-black bg-white select-none"> terminal \ users \ me: </span>
			<span id="live-clock" class="text-sm text-neutral-400"></span>
			<span>$</span>
			<span class="font-medium animate-blink"> What can I help you? </span>
		</p>
	</div>
</div>

<script define:vars={{ terminalLines, speed, delay }} is:inline>
	const output = document.getElementById("typewriter-output");
	const liveClockEl = document.getElementById("live-clock");
	
	// Check for reduced motion preference
	const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

	if (!output) return;

	/* -----------------------------------
     *  LIVE CLOCK
	----------------------------------- */
	function updateClock() {
		const now = new Date();
		const hh = String(now.getHours()).padStart(2, "0");
		const mm = String(now.getMinutes()).padStart(2, "0");
		const ss = String(now.getSeconds()).padStart(2, "0");
		liveClockEl.textContent = `[${hh}:${mm}:${ss}]`;
	}
	updateClock();
	setInterval(updateClock, 1000);

	/* -----------------------------------
     *  TYPEWRITER CONTROL
	----------------------------------- */

	let lineIndex = 0;
	let charIndex = 0;
	let currentEl = null;

	let isResetting = false;
	let activeTimers = [];

	function clearTimers() {
		activeTimers.forEach((t) => clearTimeout(t));
		activeTimers = [];
	}

	function safeTimeout(fn, t) {
		const id = setTimeout(fn, t);
		activeTimers.push(id);
		return id;
	}

	function timestamp() {
		const now = new Date();
		return `[${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(
			2,
			"0"
		)}:${String(now.getSeconds()).padStart(2, "0")}]`;
	}

	function createLineElement() {
		const el = document.createElement("div");
		el.className = "line text-success/80 truncate";
		output.appendChild(el);
		return el;
	}

	function typeLine(text) {
		if (isResetting) return;
		if (!currentEl) currentEl = createLineElement();

		if (prefersReducedMotion) {
			currentEl.textContent = text;
			currentEl = null;
			charIndex = 0;
			lineIndex++;
			safeTimeout(processNextLine, delay / 4);
			return;
		}

		if (charIndex < text.length) {
			currentEl.textContent += text[charIndex];
			charIndex++;
			safeTimeout(() => typeLine(text), speed);
		} else {
			currentEl = null;
			charIndex = 0;
			lineIndex++;
			safeTimeout(processNextLine, delay);
		}
	}

	function processNextLine() {
		if (isResetting) return;

		// finished all lines
		if (lineIndex >= terminalLines.length) {
			const end = document.createElement("div");
			end.innerHTML = `<span></span>`;
			output.appendChild(end);
			return;
		}

		const line = terminalLines[lineIndex];

		// command mode ($ ...)
		if (line.trim().startsWith("$")) {
			const cmd = document.createElement("p");
			cmd.className = "mt-3 text-nowrap flex items-center gap-4 w-full";

			const command = line.replace(/^\$\s*/, "").trim();

			cmd.innerHTML = `
				<span class="px-2 font-bold text-black bg-white select-none"> terminal \\ users \\ me: </span>
				<span class="text-sm text-neutral-400">${timestamp()}</span>
				<span>$</span>
				<span class="font-medium"> ${command} </span>
            `;

			output.appendChild(cmd);
			lineIndex++;
			safeTimeout(processNextLine, 150);
		} else {
			typeLine(line);
		}
	}

	function resetAnimation() {
		isResetting = true;
		clearTimers();

		lineIndex = 0;
		charIndex = 0;
		currentEl = null;
		output.innerHTML = "";

		safeTimeout(() => {
			isResetting = false;
			processNextLine();
		}, 500);
	}

	// start
	safeTimeout(processNextLine, 500);

	// loop every 60 seconds
	setInterval(resetAnimation, 60000);
</script>
