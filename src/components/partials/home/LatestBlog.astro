---
import { getCollection } from "astro:content";
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";
import { getReadingTime } from "@core/Content";

const locale = Astro.currentLocale || "en";

const posts = await getCollection("blog", (entry) => {
    const isNotDraft = import.meta.env.PROD ? !entry.data.draft : true;
    return isNotDraft && entry.id.startsWith(`${locale}/`);
});

const latestPosts = posts
    .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
    .slice(0, 3);
---

<section class="flex flex-col w-full gap-6 my-20" data-aos="fade-in">
    <div class="flex items-center justify-between border-b-2 border-black dark:border-white pb-2">
        <h2 class="text-xl font-black uppercase tracking-widest">&gt; {trans("latest_blog.title", {}, locale)}</h2>
        <a href={getRelativeLocaleUrl(locale, "blog")} class="text-[10px] font-bold uppercase hover:text-primary transition-colors">
            [{trans("latest_blog.view_all", {}, locale)}]
        </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {latestPosts.map((post) => {
            const readingTime = getReadingTime(post.body ?? "");
            return (
                <a 
                    href={getRelativeLocaleUrl(locale, `blog/${post.id.replace(`${locale}/`, "")}`)}
                    class="group tui-panel border-neutral-300 dark:border-neutral-800 hover:border-primary transition-all flex flex-col gap-4"
                >
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-bold text-neutral-500 uppercase">
                            {post.data.pubDate.toLocaleDateString(locale, { year: 'numeric', month: '2-digit', day: '2-digit' })}
                        </span>
                        <span class="text-[9px] font-bold text-primary px-1 border border-primary/20">
                            {readingTime}m_read
                        </span>
                    </div>

                    <h3 class="text-base font-bold group-hover:text-primary transition-colors leading-tight line-clamp-2">
                        {post.data.title}
                    </h3>
                    
                    <p class="text-xs text-neutral-500 line-clamp-3">
                        {post.data.description}
                    </p>

                    <div class="mt-auto pt-4 flex items-center justify-between border-t border-neutral-100 dark:border-neutral-900">
                        <div class="flex gap-2">
                            {post.data.tags?.slice(0, 1).map(tag => (
                                <span class="text-[8px] font-bold uppercase text-neutral-400">#{tag}</span>
                            ))}
                        </div>
                        <span class="icon-[tabler--chevron-right] size-4 text-neutral-300 group-hover:text-primary group-hover:translate-x-1 transition-all"></span>
                    </div>
                </a>
            )
        })}
    </div>
</section>