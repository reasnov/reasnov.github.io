---
import { getCollection } from "astro:content";
import { trans } from "@core/Translator";
import { getRelativeLocaleUrl } from "astro:i18n";
import { getReadingTime } from "@core/Content";

const locale = Astro.currentLocale || "en";

const posts = await getCollection("blog", (entry) => {
	const isNotDraft = import.meta.env.PROD ? !entry.data.draft : true;
	return isNotDraft && entry.id.startsWith(`${locale}/`);
});

const latestPosts = posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()).slice(0, 3);
---

<section class="my-20 flex w-full flex-col gap-6" data-aos="fade-in">
	<div class="flex items-center justify-between border-b-2 border-black pb-2 dark:border-white">
		<h2 class="text-xl font-black tracking-widest uppercase">&gt; {trans("latest_blog.title", {}, locale)}</h2>
		<a
			href={getRelativeLocaleUrl(locale, "blog")}
			class="border border-black px-2 py-0.5 text-[10px] font-bold uppercase transition-colors hover:bg-black hover:text-white dark:border-white dark:hover:bg-white dark:hover:text-black"
		>
			{trans("latest_blog.view_all", {}, locale)}
		</a>
	</div>

	<div class="grid grid-cols-1 gap-6 md:grid-cols-3">
		{
			latestPosts.map((post, index) => {
				const readingTime = getReadingTime(post.body ?? "");
				return (
					<a
						href={getRelativeLocaleUrl(locale, `blog/${post.id.replace(`${locale}/`, "")}`)}
						class="group tui-panel flex flex-col gap-4 border-neutral-300 transition-all hover:border-black dark:border-neutral-800 dark:hover:border-white"
						data-aos="fade-up"
						data-aos-delay={index * 100}
					>
						<div class="flex items-start justify-between">
							<span class="text-[9px] font-bold text-neutral-500 uppercase">
								{post.data.pubDate.toLocaleDateString(locale, {
									year: "numeric",
									month: "2-digit",
									day: "2-digit",
								})}
							</span>
							<span class="border border-black px-1 text-[9px] font-bold text-black dark:border-white dark:text-white">
								{readingTime}m_read
							</span>
						</div>

						<h3 class="line-clamp-2 text-base leading-tight font-bold transition-colors group-hover:underline">
							{post.data.title}
						</h3>

						<p class="line-clamp-3 text-xs text-neutral-500">{post.data.description}</p>

						<div class="mt-auto flex items-center justify-between border-t border-neutral-100 pt-4 dark:border-neutral-900">
							<div class="flex gap-2">
								{post.data.tags?.slice(0, 1).map((tag) => (
									<span class="text-[8px] font-bold text-neutral-400 uppercase">#{tag}</span>
								))}
							</div>
							<span class="icon-[tabler--chevron-right] size-4 text-neutral-300 transition-all group-hover:translate-x-1 group-hover:text-black dark:group-hover:text-white" />
						</div>
					</a>
				);
			})
		}
	</div>
</section>
