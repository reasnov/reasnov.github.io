---
import fakeBootLog from "@data/fake-boot-log.json";
import { trans } from "@core/Translator";

const locale = Astro.currentLocale || "en";
const terminalLines = fakeBootLog;
const speed = 10; // Faster speed for better feel
const delay = 400;

const i18n = {
	path: trans("terminal.path", {}, locale),
};
---

<div class="bg-base relative flex h-80 w-full flex-col overflow-hidden font-mono">
	<!-- Terminal Header (Inside the window) -->
	<div class="border-border/10 bg-primary flex items-center justify-between border-b px-3 py-1">
		<div class="flex items-center gap-4">
			<span class="text-primary-content flex items-center gap-2 text-[10px] font-bold tracking-widest uppercase">
				<span class="bg-accent size-2 animate-pulse rounded-full"></span>
				{trans("terminal.header", {}, locale)}
			</span>
		</div>
		<span id="live-clock" class="text-primary-content/60 text-[10px] font-bold"></span>
	</div>

	<div class="custom-scrollbar flex w-full flex-1 flex-col overflow-y-auto p-4">
		<div id="typewriter-output" class="flex w-full flex-col gap-1 text-[11px] md:text-xs"></div>

		<p class="mt-2 flex w-full items-center gap-2 text-nowrap">
			<span class="text-accent font-bold">{i18n.path}</span>
			<span class="animate-blink text-accent">â–ˆ</span>
			<span class="text-content/40 ml-2 text-[10px] italic">{trans("terminal.prompt", {}, locale)}</span>
		</p>
	</div>
</div>

<style>
	@reference "../../../styles/global.css";

	.custom-scrollbar::-webkit-scrollbar {
		width: 4px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		@apply bg-transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		@apply bg-border/20;
	}
</style>

<script define:vars={{ terminalLines, speed, delay, i18n }} is:inline>
	const output = document.getElementById("typewriter-output");
	const liveClockEl = document.getElementById("live-clock");

	const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

	if (!output) return;

	function updateClock() {
		const now = new Date();
		liveClockEl.textContent = now.toLocaleTimeString([], { hour12: false });
	}
	updateClock();
	setInterval(updateClock, 1000);

	let lineIndex = 0;
	let charIndex = 0;
	let currentEl = null;
	let isResetting = false;
	let activeTimers = [];

	function clearTimers() {
		activeTimers.forEach((t) => clearTimeout(t));
		activeTimers = [];
	}

	function safeTimeout(fn, t) {
		const id = setTimeout(fn, t);
		activeTimers.push(id);
		return id;
	}

	function timestamp() {
		const now = new Date();
		return now.toLocaleTimeString([], { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
	}

	function createLineElement() {
		const el = document.createElement("div");
		el.className = "line text-content/60 break-all leading-tight";
		output.appendChild(el);
		output.parentElement.scrollTop = output.parentElement.scrollHeight;
		return el;
	}

	function typeLine(text) {
		if (isResetting) return;
		if (!currentEl) currentEl = createLineElement();

		if (prefersReducedMotion) {
			currentEl.textContent = `[${timestamp()}] ${text}`;
			currentEl = null;
			charIndex = 0;
			lineIndex++;
			safeTimeout(processNextLine, delay / 2);
			return;
		}

		if (charIndex < text.length) {
			if (charIndex === 0) currentEl.textContent = `[${timestamp()}] `;
			currentEl.textContent += text[charIndex];
			charIndex++;
			safeTimeout(() => typeLine(text), speed);
		} else {
			currentEl = null;
			charIndex = 0;
			lineIndex++;
			safeTimeout(processNextLine, delay);
		}
	}

	function processNextLine() {
		if (isResetting) return;
		if (lineIndex >= terminalLines.length) return;

		const line = terminalLines[lineIndex];

		if (line.trim().startsWith("$")) {
			const cmd = document.createElement("div");
			cmd.className = "mt-4 mb-1 text-accent font-bold";
			cmd.textContent = `${i18n.path} ${line}`;
			output.appendChild(cmd);
			lineIndex++;
			safeTimeout(processNextLine, 200);
		} else {
			typeLine(line);
		}
	}

	function resetAnimation() {
		isResetting = true;
		clearTimers();
		lineIndex = 0;
		charIndex = 0;
		currentEl = null;
		output.innerHTML = "";
		safeTimeout(() => {
			isResetting = false;
			processNextLine();
		}, 1000);
	}

	safeTimeout(processNextLine, 500);
	setInterval(resetAnimation, 120000); // Reset every 2 minutes
</script>
