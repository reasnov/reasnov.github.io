---
import fakeBootLog from "@data/fake-boot-log.json";
import { trans } from "@core/Translator";

interface Props {
	height?: string;
}

const { height = "h-80" } = Astro.props;
const locale = Astro.currentLocale || "en";
const terminalLines = fakeBootLog;
const speed = 10;
const delay = 400;

const i18n = {
	path: trans("terminal.path", {}, locale),
};
---

<div class={`relative flex ${height} w-full flex-col overflow-hidden bg-base font-mono`}>
	<!-- Inner Header -->
	<div class="border-border/5 bg-primary/5 flex items-center justify-between border-b px-4 py-2">
		<div class="flex items-center gap-4">
			<span class="text-accent flex items-center gap-2 text-[10px] font-bold tracking-widest uppercase">
				<span class="bg-accent size-2 animate-pulse rounded-full"></span>
				{trans("terminal.header", {}, locale)}
			</span>
		</div>
		<span id="live-clock" class="text-content/30 text-[10px] font-bold"></span>
	</div>

	<div class="custom-scrollbar flex w-full flex-1 flex-col overflow-y-auto p-6">
		<div id="typewriter-output" class="flex w-full flex-col gap-1.5 text-xs md:text-sm"></div>

		<p class="mt-4 flex w-full items-center gap-3 text-nowrap">
			<span class="text-t-amber font-bold">{i18n.path}</span>
			<span class="animate-blink text-accent font-black">â–ˆ</span>
			<span class="text-content/30 text-[10px] italic">{trans("terminal.prompt", {}, locale)}</span>
		</p>
	</div>
</div>

<style>
	@reference "../../../styles/global.css";
	.custom-scrollbar::-webkit-scrollbar {
		width: 4px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		@apply bg-transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		@apply bg-border/20;
	}
</style>

<script define:vars={{ terminalLines, speed, delay, i18n }} is:inline>
	const output = document.getElementById("typewriter-output");
	const liveClockEl = document.getElementById("live-clock");
	const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

	if (output) {
		function updateClock() {
			const now = new Date();
			liveClockEl.textContent = now.toLocaleTimeString([], { hour12: false });
		}
		updateClock();
		setInterval(updateClock, 1000);

		        let lineIndex = 0;
		        let charIndex = 0;
		        let currentEl = null;
		        let isResetting = false;
		
		        function timestamp() {			const now = new Date();
			return now.toLocaleTimeString([], { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
		}

		function createLineElement() {
			const el = document.createElement("div");
			el.className = "line text-content/60 break-all leading-relaxed font-medium";
			output.appendChild(el);
			output.parentElement.scrollTop = output.parentElement.scrollHeight;
			return el;
		}

		function typeLine(text) {
			if (isResetting) return;
			if (!currentEl) currentEl = createLineElement();

			if (prefersReducedMotion) {
				currentEl.textContent = `[${timestamp()}] ${text}`;
				currentEl = null;
				lineIndex++;
				setTimeout(processNextLine, delay / 2);
				return;
			}

			if (charIndex < text.length) {
				if (charIndex === 0) currentEl.textContent = `[${timestamp()}] `;
				currentEl.textContent += text[charIndex];
				charIndex++;
				setTimeout(() => typeLine(text), speed);
			} else {
				currentEl = null;
				charIndex = 0;
				lineIndex++;
				setTimeout(processNextLine, delay);
			}
		}

		function processNextLine() {
			if (isResetting || lineIndex >= terminalLines.length) return;
			const line = terminalLines[lineIndex];
			if (line.trim().startsWith("$")) {
				const cmd = document.createElement("div");
				cmd.className =
					"mt-6 mb-2 text-accent font-bold text-sm border-l-2 border-accent pl-3 bg-accent/5 py-1";
				cmd.textContent = `${i18n.path} ${line}`;
				output.appendChild(cmd);
				lineIndex++;
				setTimeout(processNextLine, 300);
			} else {
				typeLine(line);
			}
		}

		setTimeout(processNextLine, 500);
	}
</script>
